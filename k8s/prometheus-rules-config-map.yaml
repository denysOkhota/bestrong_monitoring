apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules-conf
  namespace: monitoring
data:
  node_rules.yml: |
    groups:
    - name: node_cpu
      rules:
      - record: node_cpu_usage_percent
        expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
    
    - name: node_memory
      rules:
      - record: node_memory_MemFree_percent
        expr: 100 - (100 * node_memory_MemFree_bytes / node_memory_MemTotal_bytes)
    
    - name: alert_rules
      rules:
        - alert: HighCPULoad
          expr: node_cpu_usage_percent > 70
          labels:
            severity: warning
          annotations:
            description: 'High CPU load detected on {{ $labels.instance }}'
            summary: 'High CPU Load'

        - alert: RAMMemoryFree30Percent
          expr: node_memory_MemFree_percent <= 30
          labels:
            severity: warning